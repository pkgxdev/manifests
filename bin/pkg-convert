#!/usr/bin/env -S pkgx -q make -f

.PHONY: all debug
MAKEFILE_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))
SRCROOT := $(abspath $(MAKEFILE_DIR)/..)
PKG_FILES := $(shell find $(SRCROOT)/projects -name package.yml)
OUTPUTS := $(PKG_FILES:$(SRCROOT)/projects/%=$(SRCROOT)/artifacts/pantry/projects/%)

ifeq ($(OS),Windows_NT)
	DENO := deno run -RW
endif

# Default target
all: $(OUTPUTS)

# Rule to process each package.yml file
$(SRCROOT)/artifacts/pantry/projects/%: $(SRCROOT)/projects/%
	@mkdir -p $(dir $@)
	$(DENO) $(SRCROOT)/brewkit/scripts/convert-package.yml.ts "$<" > "$@"

debug:
	@echo "PKG_FILES: $(PKG_FILES)"
	@echo "OUTPUTS: $(OUTPUTS)"
	@echo "SRCROOT: $(SRCROOT)"
